# CZT-Contrib RabbitMQ Module

åŸºäº [RabbitMQ](https://www.rabbitmq.com/) æ„å»ºçš„é«˜æ€§èƒ½æ¶ˆæ¯é˜Ÿåˆ—å®¢æˆ·ç«¯ï¼Œä¸“ä¸º Go-Zero æ¡†æ¶è®¾è®¡çš„åˆ†å¸ƒå¼æ¶ˆæ¯å¤„ç†æ¨¡å—ã€‚

## âœ¨ ç‰¹æ€§

- ğŸš€ **é«˜æ€§èƒ½**: åŸºäº AMQP åè®®çš„é«˜æ€§èƒ½æ¶ˆæ¯é˜Ÿåˆ—
- ğŸ”— **é“¾è·¯è¿½è¸ª**: é›†æˆ OpenTelemetry åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª
- ğŸ“Š **ç›‘æ§æŒ‡æ ‡**: å†…ç½® Prometheus æŒ‡æ ‡æ”¶é›†
- ğŸ›¡ï¸ **é”™è¯¯æ¢å¤**: è‡ªåŠ¨é‡è¿å’Œé”™è¯¯å¤„ç†æœºåˆ¶
- ğŸ”„ **æ¶ˆæ¯ç¡®è®¤**: æ”¯æŒå¯é çš„æ¶ˆæ¯ç¡®è®¤æœºåˆ¶
- âš¡ **å¹¶å‘æ§åˆ¶**: çµæ´»çš„ QoS é…ç½®å’Œå¹¶å‘æ§åˆ¶
- ğŸ”§ **é…ç½®çµæ´»**: æ”¯æŒå¤šç§æ¶ˆæ¯æ¨¡å¼å’Œé˜Ÿåˆ—é…ç½®

## ğŸ“¦ å®‰è£…

```bash
go get github.com/lerity-yao/czt-contrib/mq/rabbitmq
```

## ğŸ“¦ æœåŠ¡ç”Ÿæˆ

æ”¯æŒç±»ä¼¼ goctl å·¥å…·ä¸€é”®ç”ŸæˆæœåŠ¡ç«¯ä»£ç ï¼Œ å·¥å…·ä¸º cztctl, æ˜¯goctlé­”æ”¹çš„

ä¹Ÿå¯ä»¥è‡ªå®šä¹‰æœåŠ¡ç«¯ä»£ç ç”Ÿæˆæ¨¡æ¿

è¯·å‚è€ƒ https://github.com/lerity-yao/go-zero/tree/cztctl

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç”Ÿäº§è€…ï¼ˆå®¢æˆ·ç«¯ï¼‰ä½¿ç”¨

```go
package main

import (
	"context"
	"encoding/json"
	"fmt"
	"time"

	"github.com/lerity-yao/czt-contrib/mq/rabbitmq"
)

func main() {
	// é…ç½®ç”Ÿäº§è€…
	conf := rabbitmq.RabbitSenderConf{
		RabbitConf: rabbitmq.RabbitConf{
			Username: "guest",
			Password: "guest",
			Host:     "localhost",
			Port:     5672,
			VHost:    "/",
		},
		ContentType: "application/json",
	}

	// åˆ›å»ºç”Ÿäº§è€…å®¢æˆ·ç«¯
	ctx := context.Background()
	client, err := rabbitmq.MustNewSenderClient(ctx, conf)
	if err != nil {
		panic(err)
	}

	// å‘é€æ¶ˆæ¯
	message := map[string]interface{}{
		"order_id": "12345",
		"amount":   99.99,
		"user_id":  "user001",
	}

	payload, _ := json.Marshal(message)
	
	// å‘é€åˆ°æŒ‡å®šäº¤æ¢æœºå’Œè·¯ç”±é”®
	err = client.Send(ctx, "order.exchange", "order.created", payload)
	if err != nil {
		panic(err)
	}

	fmt.Println("æ¶ˆæ¯å‘é€æˆåŠŸ!")
}
```

### 2. æ¶ˆè´¹è€…ï¼ˆæœåŠ¡ç«¯ï¼‰ä½¿ç”¨

```go
package main

import (
	"context"
	"encoding/json"
	"flag"

	"github.com/lerity-yao/czt-contrib/mq/rabbitmq"
	"github.com/zeromicro/go-zero/core/logc"
	"github.com/zeromicro/go-zero/core/logx"
	"github.com/zeromicro/go-zero/core/service"
	"github.com/zeromicro/go-zero/rest"
)

// é…ç½®ç»“æ„
type Config struct {
	rest.RestConf
	RabbitMqConf rabbitmq.RabbitListenerConf
}

// æ¶ˆæ¯ç»“æ„
type OrderMessage struct {
	OrderID string  `json:"order_id"`
	Amount  float64 `json:"amount"`
	UserID  string  `json:"user_id"`
}

// æ¶ˆè´¹è€…é€»è¾‘
type OrderProcessor struct {
	config Config
}

func NewOrderProcessor(c Config) *OrderProcessor {
	return &OrderProcessor{config: c}
}

func (p *OrderProcessor) Consume(ctx context.Context, message []byte) error {
	var order OrderMessage
	
	if err := json.Unmarshal(message, &order); err != nil {
		logc.Errorf(ctx, "æ¶ˆæ¯è§£æå¤±è´¥: %v, åŸå§‹æ¶ˆæ¯: %s", err, string(message))
		return err
	}

	logc.Infof(ctx, "å¤„ç†è®¢å•: ID=%s, é‡‘é¢=%.2f, ç”¨æˆ·=%s", 
		order.OrderID, order.Amount, order.UserID)

	// å¤„ç†ä¸šåŠ¡é€»è¾‘
	// ä¾‹å¦‚ï¼šæ›´æ–°æ•°æ®åº“ã€å‘é€é€šçŸ¥ç­‰
	
	return nil
}

// åˆ›å»ºæ¶ˆè´¹è€…æœåŠ¡
func CreateRabbitMQService(c Config) service.Service {
	logx.Infof("è¿æ¥ RabbitMQ: %s:%d, ç›‘å¬é˜Ÿåˆ—: %v",
		c.RabbitMqConf.Host, c.RabbitMqConf.Port,
		c.RabbitMqConf.ListenerQueues)

	ctx := context.Background()
	return rabbitmq.MustNewListener(ctx, c.RabbitMqConf, NewOrderProcessor(c))
}

func main() {
	flag.Parse()

	// é…ç½®æ¶ˆè´¹è€…é˜Ÿåˆ—
	queueConfig := rabbitmq.ConsumerConf{
		Name:          "order.queue",
		MaxRetryCount: 3,
		AutoAck:       false,  // æ‰‹åŠ¨ç¡®è®¤
		Exclusive:     false,  // å…è®¸å¤šä¸ªæ¶ˆè´¹è€…
		NoLocal:       false,
		NoWait:        false,
	}

	queues := []rabbitmq.ConsumerConf{queueConfig}

	config := Config{
		RestConf: rest.RestConf{
			Host: "0.0.0.0",
			Port: 8080,
		},
		RabbitMqConf: rabbitmq.RabbitListenerConf{
			RabbitConf: rabbitmq.RabbitConf{
				Username: "guest",
				Password: "guest",
				Host:     "localhost",
				Port:     5672,
				VHost:    "/",
			},
			ListenerQueues: queues,
			ChannelQos: rabbitmq.ChannelQosConf{
				PrefetchCount: 10, // æ¯æ¬¡é¢„å–10æ¡æ¶ˆæ¯
				PrefetchSize:  0,
				Global:        false,
			},
			ContentType: "application/json",
		},
	}

	// è®¾ç½®æœåŠ¡
	if err := config.SetUp(); err != nil {
		panic(err)
	}

	// å¯åŠ¨æœåŠ¡ç»„
	serviceGroup := service.NewServiceGroup()
	defer serviceGroup.Stop()

	// æ·»åŠ RabbitMQæ¶ˆè´¹è€…æœåŠ¡
	serviceGroup.Add(CreateRabbitMQService(config))

	// å¯åŠ¨æœåŠ¡
	serviceGroup.Start()
}
```

## âš™ï¸ é…ç½®è¯´æ˜

### RabbitMQ åŸºç¡€é…ç½®

```go
type RabbitConf struct {
	Username string  // ç”¨æˆ·å
	Password string  // å¯†ç 
	Host     string  // ä¸»æœºåœ°å€
	Port     int     // ç«¯å£å·
	VHost    string `json:",optional"` // è™šæ‹Ÿä¸»æœº
}
```

### ç”Ÿäº§è€…é…ç½®

```go
type RabbitSenderConf struct {
	RabbitConf
	ContentType string `json:",default=text/plain"` // æ¶ˆæ¯å†…å®¹ç±»å‹
}
```

### æ¶ˆè´¹è€…é…ç½®

```go
type RabbitListenerConf struct {
	RabbitConf
	ListenerQueues []ConsumerConf  // ç›‘å¬é˜Ÿåˆ—é…ç½®
	ChannelQos     ChannelQosConf  // é€šé“QoSé…ç½®
	ContentType    string `json:",default=text/plain"` // æ¶ˆæ¯å†…å®¹ç±»å‹
}
```

### é˜Ÿåˆ—æ¶ˆè´¹é…ç½®

```go
type ConsumerConf struct {
	Name          string  // é˜Ÿåˆ—åç§°
	MaxRetryCount int32 `json:",default=3"`    // æœ€å¤§é‡è¯•æ¬¡æ•°
	AutoAck       bool  `json:",default=false"` // è‡ªåŠ¨ç¡®è®¤
	Exclusive     bool  `json:",default=false"` // ç‹¬å æ¨¡å¼
	NoLocal       bool  `json:",default=false"` // ç¦æ­¢æœ¬åœ°æ¶ˆè´¹
	NoWait        bool  `json:",default=false"` // éé˜»å¡æ¨¡å¼
}
```

### é€šé“ QoS é…ç½®

```go
type ChannelQosConf struct {
	PrefetchCount int  `json:",default=5"`   // é¢„å–æ¶ˆæ¯æ•°é‡
	PrefetchSize  int  `json:",default=0"`   // é¢„å–æ¶ˆæ¯å¤§å°ï¼ˆå­—èŠ‚ï¼‰
	Global        bool `json:",default=false"` // å…¨å±€ç”Ÿæ•ˆ
}
```

## ğŸ”§ é«˜çº§åŠŸèƒ½

### 1. é“¾è·¯è¿½è¸ª

æ¨¡å—è‡ªåŠ¨é›†æˆ OpenTelemetryï¼Œæ”¯æŒåˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªï¼š

- **ç”Ÿäº§è€…ç«¯**: è‡ªåŠ¨åˆ›å»ºç”Ÿäº§è€… Span
- **æ¶ˆè´¹è€…ç«¯**: ä»æ¶ˆæ¯å¤´æå–è¿½è¸ªä¿¡æ¯
- **è·¨æœåŠ¡è¿½è¸ª**: æ”¯æŒè·¨å¤šä¸ªæœåŠ¡çš„å®Œæ•´è°ƒç”¨é“¾

### 2. ç›‘æ§æŒ‡æ ‡

å†…ç½® Prometheus æŒ‡æ ‡æ”¶é›†ï¼š

- `mq_consume_total`: æ¶ˆæ¯æ¶ˆè´¹æ€»æ•°ç»Ÿè®¡
- `mq_consume_duration_ms`: æ¶ˆæ¯æ¶ˆè´¹è€—æ—¶ç»Ÿè®¡

### 3. å†…ç½®æ‹¦æˆªå™¨

æ¨¡å—æä¾›ä»¥ä¸‹å†…ç½®æ‹¦æˆªå™¨ï¼š

- **RecoveryInterceptor**: è‡ªåŠ¨ panic æ¢å¤
- **TraceInterceptor**: é“¾è·¯è¿½è¸ª
- **PrometheusInterceptor**: æŒ‡æ ‡æ”¶é›†
- **LoggingInterceptor**: æ—¥å¿—è®°å½•

### 4. è‡ªå®šä¹‰æ‹¦æˆªå™¨

```go
// è‡ªå®šä¹‰æ‹¦æˆªå™¨ç¤ºä¾‹
func customInterceptor(ctx context.Context, queueName string, message []byte, next func(context.Context, []byte) error) error {
	start := time.Now()
	
	// å‰ç½®å¤„ç†
	logc.Infof(ctx, "å¼€å§‹å¤„ç†é˜Ÿåˆ— %s çš„æ¶ˆæ¯", queueName)
	
	// æ‰§è¡Œä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨æˆ–ä¸šåŠ¡é€»è¾‘
	err := next(ctx, message)
	
	// åç½®å¤„ç†
	duration := time.Since(start)
	if err != nil {
		logc.Errorf(ctx, "å¤„ç†å¤±è´¥ï¼Œè€—æ—¶: %v, é”™è¯¯: %v", duration, err)
	} else {
		logc.Infof(ctx, "å¤„ç†æˆåŠŸï¼Œè€—æ—¶: %v", duration)
	}
	
	return err
}

// ä½¿ç”¨è‡ªå®šä¹‰æ‹¦æˆªå™¨
interceptor := rabbitmq.Chain(
	rabbitmq.RecoveryInterceptor,
	rabbitmq.TraceInterceptor,
	customInterceptor,  // æ·»åŠ è‡ªå®šä¹‰æ‹¦æˆªå™¨
	rabbitmq.PrometheusInterceptor,
)
```

## ğŸ† æœ€ä½³å®è·µ

### 1. æ¶ˆæ¯è®¾è®¡

- **æ¶ˆæ¯æ ¼å¼**: ä½¿ç”¨ JSON æ ¼å¼ï¼Œä¾¿äºåºåˆ—åŒ–å’Œè°ƒè¯•
- **æ¶ˆæ¯å¤§å°**: æ§åˆ¶æ¶ˆæ¯å¤§å°ï¼Œé¿å…å¤§æ¶ˆæ¯å½±å“æ€§èƒ½
- **å¹‚ç­‰æ€§**: ç¡®ä¿æ¶ˆæ¯å¤„ç†æ˜¯å¹‚ç­‰çš„ï¼Œæ”¯æŒé‡è¯•

### 2. é˜Ÿåˆ—é…ç½®

- **æŒä¹…åŒ–**: é‡è¦æ¶ˆæ¯åº”è®¾ç½®æŒä¹…åŒ–é˜Ÿåˆ—
- **æ­»ä¿¡é˜Ÿåˆ—**: é…ç½®æ­»ä¿¡é˜Ÿåˆ—å¤„ç†å¤±è´¥æ¶ˆæ¯
- **TTL**: è®¾ç½®åˆç†çš„æ¶ˆæ¯è¿‡æœŸæ—¶é—´

### 3. é”™è¯¯å¤„ç†

- **é‡è¯•æœºåˆ¶**: åˆç†é…ç½®é‡è¯•æ¬¡æ•°å’Œé—´éš”
- **æ­»ä¿¡å¤„ç†**: å¤„ç†æ— æ³•é‡è¯•æˆåŠŸçš„æ¶ˆæ¯
- **ç›‘æ§å‘Šè­¦**: è®¾ç½®æ¶ˆæ¯ç§¯å‹å’Œå¤±è´¥å‘Šè­¦

### 4. æ€§èƒ½ä¼˜åŒ–

- **QoS é…ç½®**: æ ¹æ®ä¸šåŠ¡éœ€æ±‚è°ƒæ•´é¢„å–æ•°é‡
- **å¹¶å‘æ§åˆ¶**: åˆç†è®¾ç½®æ¶ˆè´¹è€…å¹¶å‘æ•°
- **è¿æ¥å¤ç”¨**: å¤ç”¨è¿æ¥å’Œé€šé“ï¼Œå‡å°‘å¼€é”€

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è¿æ¥å¤±è´¥**
    - æ£€æŸ¥ RabbitMQ æœåŠ¡çŠ¶æ€
    - éªŒè¯ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®
    - ç¡®è®¤ç”¨æˆ·åå¯†ç å’Œæƒé™

2. **æ¶ˆæ¯ä¸¢å¤±**
    - ç¡®è®¤æ¶ˆæ¯æŒä¹…åŒ–è®¾ç½®
    - æ£€æŸ¥æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶
    - éªŒè¯æ­»ä¿¡é˜Ÿåˆ—é…ç½®

3. **æ€§èƒ½é—®é¢˜**
    - è°ƒæ•´ QoS é¢„å–è®¾ç½®
    - ä¼˜åŒ–æ¶ˆæ¯å¤§å°å’Œæ ¼å¼
    - å¢åŠ æ¶ˆè´¹è€…å®ä¾‹


## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“ è”ç³»æ–¹å¼

- é¡¹ç›®ä¸»é¡µ: [GitHub](https://github.com/lerity-yao/czt-contrib)
- é—®é¢˜åé¦ˆ: [Issues](https://github.com/lerity-yao/czt-contrib/issues)